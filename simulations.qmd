---
title: "QUD-RSA Model Simulations"
format:
  html:
    code-fold: true
    fig-width: 10
    fig-height: 6
---

```{r}
#| label: setup
#| message: false

library(tidyverse)
theme_set(theme_minimal(base_size = 12))
```

## Generate Predictions

```{r}
#| label: run-model

system("python rsa_ch2.py --ablations ablations.csv")

ablations <- read_csv("ablations.csv", show_col_types = FALSE) |>
  mutate(model = factor(model, levels = c("No Register", "With Register")))

glimpse(ablations)
```

## Model Comparison

```{r}
#| label: fig-rmse-comparison
#| fig-cap: "Register improves model fit"
#| fig-height: 4

rmse_summary <- ablations |>
  group_by(model) |>
  summarise(RMSE = mean(avg_rmse), .groups = "drop")

ggplot(rmse_summary, aes(x = model, y = RMSE, fill = model)) +
  geom_col(alpha = 0.8, width = 0.6) +
  geom_text(aes(label = round(RMSE, 3)), vjust = -0.5, size = 5) +
  scale_fill_manual(values = c("No Register" = "#e74c3c", "With Register" = "#27ae60")) +
  labs(x = NULL, y = "Average RMSE (lower = better)",
       title = "Register dimension improves fit") +
  theme(legend.position = "none") +
  ylim(0, 0.16)

ggsave("rmse_comparison.png", width = 6, height = 4, dpi = 150)
```

## Fitted Parameters

```{r}
#| label: tbl-params

ablations |>
  distinct(model, alpha, cost_w) |>
  rename(`Î±` = alpha, `Cost weight` = cost_w) |>
  knitr::kable(digits = 4, caption = "Fitted parameters by model")
```

## Predictions by Outlet

```{r}
#| label: fig-predictions
#| fig-cap: "Observed vs predicted by outlet"
#| fig-height: 5

best_df <- ablations |>
  filter(model == "With Register")

pred_long <- best_df |>
  select(outlet, pred_bm, pred_tgw, pred_tw, obs_bm, obs_tgw, obs_tw) |>
  pivot_longer(-outlet, names_to = c("type", "utterance"), names_sep = "_") |>
  mutate(
    type = if_else(type == "pred", "Predicted", "Observed"),
    utterance = factor(utterance, levels = c("bm", "tgw", "tw"),
                      labels = c("BM", "TGW", "TW")),
    outlet = factor(outlet, levels = c("Breitbart", "NPR", "PinkNews"))
  )

rmse_labels <- best_df |>
  select(outlet, rmse) |>
  mutate(label = paste0("RMSE = ", round(rmse, 3)))

ggplot(pred_long, aes(x = utterance, y = value, fill = type)) +
  geom_col(position = "dodge", alpha = 0.8) +
  facet_wrap(~outlet) +
  geom_text(data = rmse_labels, aes(x = 2, y = 0.9, label = label),
            inherit.aes = FALSE, size = 3.5) +
  scale_fill_manual(values = c("Observed" = "gray50", "Predicted" = "#27ae60")) +
  labs(x = NULL, y = "Proportion", fill = NULL,
       title = "Model with Register") +
  theme(legend.position = "bottom")

ggsave("predictions.png", width = 10, height = 5, dpi = 150)
```

## With vs Without Register

```{r}
#| label: fig-register-effect
#| fig-cap: "Effect of register on predictions"
#| fig-height: 5

compare_df <- ablations |>
  select(model, outlet, pred_bm, pred_tgw, pred_tw, obs_bm, obs_tgw, obs_tw) |>
  pivot_longer(cols = c(pred_bm:obs_tw),
               names_to = c("type", "utterance"),
               names_sep = "_") |>
  mutate(
    type = case_when(
      type == "pred" & model == "No Register" ~ "No Register",
      type == "pred" & model == "With Register" ~ "With Register",
      type == "obs" ~ "Observed"
    ),
    utterance = factor(utterance, levels = c("bm", "tgw", "tw"),
                      labels = c("BM", "TGW", "TW")),
    outlet = factor(outlet, levels = c("Breitbart", "NPR", "PinkNews"))
  ) |>
  filter(!is.na(type)) |>
  distinct()

ggplot(compare_df, aes(x = utterance, y = value, fill = type)) +
  geom_col(position = "dodge", alpha = 0.8) +
  facet_wrap(~outlet) +
  scale_fill_manual(values = c("Observed" = "gray30",
                                "With Register" = "#27ae60",
                                "No Register" = "#e74c3c")) +
  labs(x = NULL, y = "Proportion", fill = NULL,
       title = "Register helps capture TW preference at PinkNews") +
  theme(legend.position = "bottom")

ggsave("register_effect.png", width = 10, height = 5, dpi = 150)
```

